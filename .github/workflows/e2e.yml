name: E2E (MCP Inspector)

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  e2e:
    name: Inspector tools/list
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.90.0
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Lint (clippy)
        run: cargo clippy --all-targets -- -D warnings
      - name: Build (release)
        run: cargo build --release --locked

      - name: Inspector tools/list
        timeout-minutes: 10
        run: |
          export MCP_DIAG_LOG="$GITHUB_WORKSPACE/mcp-diag.log"
          npx @modelcontextprotocol/inspector-cli --cli ./target/release/github-mcp --method tools/list --timeout-ms 30000 > out-tools.json || npx @modelcontextprotocol/inspector-cli --cli ./target/release/github-mcp --method tools/list > out-tools.json
          if [ -f out-tools.json ]; then cat out-tools.json; else echo "out-tools.json missing"; fi
          # Validate tools/list succeeded and includes a stable GitHub tool.
          # Note: MCP "ping" is a base method (not a tool) per spec; Inspector cannot call arbitrary JSON-RPC methods as tools.
          node -e '
            const o = require("./out-tools.json");
            if (!o.result || !Array.isArray(o.result.tools)) {
              console.error("invalid tools/list result");
              process.exit(1);
            }
            const names = o.result.tools.map(t => t && t.name).filter(Boolean);
            const ok = names.includes("list_issues") || names.includes("get_issue");
            if (!ok) {
              console.error("expected GitHub tool missing: list_issues or get_issue");
              process.exit(1);
            }
          '
      - name: Smoke stdio LF-only
        run: |
          node ./scripts/smoke_stdio_lf.js ./target/release/github-mcp
      - name: Upload MCP diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-diag
          path: |
            mcp-diag.log
            diag-smoke.log
            out-tools.json
